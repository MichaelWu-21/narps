### Code for NARPS data analysis

#### Setup

The original data should be downloaded from https://www.dropbox.com/s/wu0zrrwn2gtqbph/narps_origdata.tgz?dl=0 and unzipped into a new directory, which will be come the base directory for the analysis data. 

This can also be done using the 

The required data (all contained in the unzipped ```orig``` directory) are:
- thresholded and unthresholded images for each team/hypothesis (teams excluded from the main analysis are included in the ```rejected``` directory)
- metadata files:
    - ```analysis_pipelines_SW.xlsx``` (information about analysis pipelines)
    - ```narps_neurovault_images_details.csv``` (information about images)
    - ```narps_results.xlsx``` (information about team decisions)

In addition, there is a set of template files (redistributed from the FSL distribution) contained in the ```templates``` directory:
    - ```templates/MNI152_T1_2mm.nii.gz```
    - ```templates/MNI152_T1_2mm_brain_mask.nii.gz```


#### Dockerized analysis pipeline

To run the full analysis pipeline using Docker, do the following:

- Install the [Docker client](https://docs.docker.com/install/)
- set the following environment variables:
    - ```NARPS_BASEDIR```: directory containing the original NARPS data files (which need not be the directory where the code is located)
- clone this repository and cd to the cloned directory
- download the data using: ```make get-data```
- use the following command to run the full pipeline: ```make run-all```

This performs the following steps:

- Preparation of the data for analysis(using PrepareMaps.ipynb)
- Preparation of the metadata (using PrepareMetadata.ipynb)
- Analysis of the maps (using AnalyzeMaps.ipynb)
- Analysis of the decisions (using AnalyzeDecisions.Rmd)
- Consensus analysis across teams (using ConsensusAnalysis.ipynb)

The outputs can be found in the subdirectories of NARPS_BASEDIR:
- ```maps``` - all of the intermediate maps generated by preprocessing
- ```figures``` - figures generated by the analysis code
- ```metadata``` - additional metadata files generated by the preparation code
- ```cached``` - the cached narps structure 

This will use the existing version of the docker image from Dockerhub.  If you wish to build the Docker image locally, you should change the DOCKER_USERNAME variable in the Makefile to your own username, and then run ```make docker-build```.

### Details

```narps.py``` contains a class that stores much of the information about the dataset.  Most of the notebooks load the stored narps structure that is saved by PrepareMaps.ipynb.  


### Notes on data

Data and hypothesis decisions were obtained from 70 teams.  Of these, the maps for 16 teams were excluded from further analysis due to the following problems:

##### Bad normalization/resampling:

- SVXXBBHN_98BT: rejected due to very bad normalization
- UGXECSGG_L1A8: resampled image much smaller than template brain
- VDOVGCPL_4SZ2: resampled image offset from template brain
- WBTVHMSS_4TQ6: resampled image  offset and too large compared to template


##### Missing thresholded images:

- WIYTWEEA_2T7P: missing thresholded images


##### Used surface-based analysis (only provided data for cortical ribbon:

- DRVQPPNO_1K0E
- UMSEIVRB_X1Z4 


##### Missing data:

- YWGVKXBZ_6FH5: missing much of the central brain
- ACMKXFTG_P5F3: rejected due to large amounts of missing data across brain
- NNUNPWLT_0H5E: rejected due to large amount of missing brain in center
- CMJIFMMR_L3V8: rejected due to large amount of missing brain in center


##### Bad histograms:  
visual examiniation of histograms of unthresholded images showed a number of them that were clearly not distribted as z/t

- RIIVGRDK_E3B6: very long tail, with substantial inflation at a value just below zero
- JAWCZRDS_V55J: very small values
- EPBGXICO_I07H: bimodal, with second distribution centered around 2.5
- UXJVRRRR_0C7Q: appears to be a p-value distribution, with slight excursions below and above zero
- OXLAIRNK_Q58J: bimodal, zero-inflated with a second distribution centered around 5

