### Code for NARPS data analysis

#### Setup

The original data should be downloaded from https://www.dropbox.com/s/wu0zrrwn2gtqbph/narps_origdata.tgz?dl=0 and unzipped into a new directory, which will be come the base directory for the analysis data. The required data (all contained in the unzipped ```orig``` directory) are:
- thresholded and unthresholded images for each team/hypothesis (teams excluded from the main analysis are included in the ```rejected``` directory)
- metadata files:
    - ```analysis_pipelines_SW.xlsx``` (information about analysis pipelines)
    - ```narps_neurovault_images_details.csv``` (information about images)
    - ```narps_results.xlsx``` (information about team decisions)

In addition, there is a set of template files (redistributed from the FSL distribution) contained in the ```templates``` directory:
    - ```templates/MNI152_T1_2mm.nii.gz```
    - ```templates/MNI152_T1_2mm_brain_mask.nii.gz```


#### Dockerized analysis pipeline

To run the full analysis pipeline using Docker, do the following:

- Install the [Docker client](https://docs.docker.com/install/)
- Download and unzip the original data files
- set the following environment variables:
    - ```NARPS_BASEDIR```: directory containing the original NARPS data files (which need not be the directory where the code is located)
- clone this repository and cd to the cloned directory
- use the following command to run the full pipeline: ```make run-all```

This performs the following steps:

- Preparation of the data for analysis(using PrepareMaps.ipynb)
- Preparation of the metadata (using PrepareMetadata.ipynb)
- Analysis of the maps (using AnalyzeMaps.ipynb)
- Analysis of the decisions (using AnalyzeDecisions.Rmd)
- Consensus analysis across teams (using ConsensusAnalysis.ipynb)

The outputs can be found in the subdirectories of NARPS_BASEDIR:
- ```maps``` - all of the intermediate maps generated by preprocessing
- ```figures``` - figures generated by the analysis code
- ```metadata``` - additional metadata files generated by the preparation code
- ```cached``` - the cached narps structure 

### Details

```narps.py``` contains a class that stores much of the information about the dataset.  Most of the notebooks load the stored narps structure that is saved by PrepareMaps.ipynb.  